//============================================================================
// Name        : FunctionTracer.cpp
// Author      : Michael Rossner
// Version     :
// Copyright   : LGPL2
// Description : Hello World in C++, Ansi-style
//============================================================================

#include "FunctionTracer.h"

guarded_map<int, int> FunctionTraceCounter;
int FunctionTrace_TraceLevel = 10;

void SetTraceLevel(int level){
   FunctionTrace_TraceLevel = level;
}
void FunctionTracer::Constructor(){
   ThreadId = getpid();
   int Counter = FunctionTraceCounter.get(ThreadId);
   Counter++;
   sIndent = std::string((size_t)(Counter*2), '-');
   if (Counter <= FunctionTrace_TraceLevel){
      std::cout << sIndent << "FunctionTracer Entry:" << sFunctionName << " - ThreadId = " << ThreadId << " - CallDepth = " << Counter << std::endl;
      if(-1 == clock_gettime(CLOCK_MONOTONIC_COARSE, &Entry_Clock_Time)) {
         perror( "clock gettime CLOCK_MONOTONIC_COARSE" );
      }
      if (-1 == clock_gettime(CLOCK_THREAD_CPUTIME_ID, &Entry_Cpu_Time)) {
         perror( "clock gettime CLOCK_THREAD_CPUTIME_ID" );
      }
      EntryTraceDone = true;
   }
   FunctionTraceCounter.set(ThreadId, Counter);

}
void FunctionTracer::Destructor(){
   ThreadId = getpid();
   int Counter = FunctionTraceCounter.get(ThreadId);
   if (Counter <= FunctionTrace_TraceLevel){
      timespec Cpu_Time, Clock_Time;
      if (-1 == clock_gettime(CLOCK_MONOTONIC_COARSE, &Clock_Time)){
         perror("clock_gettime CLOCK_MONOTONIC_COARSE");
      }
      if (-1 == clock_gettime(CLOCK_THREAD_CPUTIME_ID, &Cpu_Time)){
         perror("clock_gettime CLOCK_THREAD_CPUTIME_ID");
      }
      int Clock_Duration = Clock_Time.tv_nsec-Entry_Clock_Time.tv_nsec;
      int CPU_Duration = Cpu_Time.tv_nsec-Entry_Cpu_Time.tv_nsec;
      int Counter = FunctionTraceCounter.get(ThreadId);
      std::cout << sIndent << "FunctionTracer Exit :" << sFunctionName << " - ThreadId = " << ThreadId << " - CallDepth = " << Counter << std::endl;
      std::cout << sIndent << "Function used CPU for " << (CPU_Duration / 1000 / 1000) << "ms" << std::endl;
      std::cout << sIndent << "Function Duration     " << (Clock_Duration / 1000 / 1000) << "ms" << std::endl;
      ExitTraceDone = true;
   }
   Counter--;
   FunctionTraceCounter.set(ThreadId, Counter);
}
